<!DOCTYPE html><meta charset="utf-8"/><hgroup><h1>Proxy Reactivity</h1><p>kinda neat</p></hgroup>
<blockquote>
<p>The Proxy object enables you to create a proxy for another object, which can intercept and redefine fundamental operations for that object. - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">MDN</a></p>
</blockquote>
<p>Here is a method for basic reactivity using a Proxy.</p>
<pre class="astro-code snazzy-light" style="background-color:#FAFBFC;color:#565869;overflow-x:auto" tabindex="0" data-language="js"><code><span class="line"><span style="color:#ADB1C2">// our initial state</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#565869"> initialState </span><span style="color:#ADB1C2">=</span><span style="color:#ADB1C2"> {}</span></span>
<span class="line"><span style="color:#ADB1C2">// a map of properties to their subscribers</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#565869"> listeners </span><span style="color:#ADB1C2">=</span><span style="color:#F767BB"> new</span><span style="color:#09A1ED"> Map</span><span style="color:#ADB1C2">();</span></span>
<span class="line"><span style="color:#ADB1C2">// our proxy</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#565869"> state </span><span style="color:#ADB1C2">=</span><span style="color:#F767BB"> new</span><span style="color:#09A1ED"> Proxy</span><span style="color:#ADB1C2">(</span><span style="color:#565869">initialState</span><span style="color:#ADB1C2">,</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#09A1ED">    set</span><span style="color:#ADB1C2">(</span><span style="color:#565869">target</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> property</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> value</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#F767BB">        const</span><span style="color:#565869"> old </span><span style="color:#ADB1C2">=</span><span style="color:#565869"> target</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">];</span></span>
<span class="line"><span style="color:#565869">        target</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">]</span><span style="color:#ADB1C2"> =</span><span style="color:#565869"> value</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#F767BB">        if</span><span style="color:#ADB1C2">(</span><span style="color:#565869">old </span><span style="color:#ADB1C2">!==</span><span style="color:#565869"> value</span><span style="color:#ADB1C2">){</span></span>
<span class="line"><span style="color:#F767BB">            if</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">listeners</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">has</span><span style="color:#ADB1C2">(</span><span style="color:#565869">property</span><span style="color:#ADB1C2">))</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#ADB1C2">                // if we have subscribers for this property, run them</span></span>
<span class="line"><span style="color:#565869">                listeners</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">get</span><span style="color:#ADB1C2">(</span><span style="color:#565869">property</span><span style="color:#ADB1C2">).</span><span style="color:#09A1ED">forEach</span><span style="color:#ADB1C2">(</span><span style="color:#565869">fn </span><span style="color:#ADB1C2">=&gt;</span><span style="color:#09A1ED"> fn</span><span style="color:#ADB1C2">(</span><span style="color:#565869">value</span><span style="color:#ADB1C2">));</span></span>
<span class="line"><span style="color:#ADB1C2">            }</span></span>
<span class="line"><span style="color:#ADB1C2">        }</span></span>
<span class="line"><span style="color:#F767BB">        return</span><span style="color:#2DAE58"> true</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#ADB1C2">    }</span></span>
<span class="line"><span style="color:#ADB1C2">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADB1C2">// now our listener creator</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#09A1ED"> listen</span><span style="color:#ADB1C2"> =</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">property</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> fn</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> =&gt;</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#565869">  listeners</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">set</span><span style="color:#ADB1C2">(</span><span style="color:#565869">property</span><span style="color:#ADB1C2">,</span><span style="color:#ADB1C2"> [...(</span><span style="color:#565869">listeners</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">get</span><span style="color:#ADB1C2">(</span><span style="color:#565869">property</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> ||</span><span style="color:#ADB1C2"> []),</span><span style="color:#565869"> fn</span><span style="color:#ADB1C2">]);</span></span>
<span class="line"><span style="color:#ADB1C2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADB1C2">// we can now listen to changes on x</span></span>
<span class="line"><span style="color:#09A1ED">listen</span><span style="color:#ADB1C2">(</span><span style="color:#ADB1C2">&quot;</span><span style="color:#CF9C00">x</span><span style="color:#ADB1C2">&quot;</span><span style="color:#ADB1C2">,</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">v</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> =&gt;</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#565869">    console</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">log</span><span style="color:#ADB1C2">(</span><span style="color:#ADB1C2">&quot;</span><span style="color:#CF9C00">x changed to</span><span style="color:#ADB1C2">&quot;</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> v</span><span style="color:#ADB1C2">);</span></span>
<span class="line"><span style="color:#ADB1C2">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#565869">state</span><span style="color:#ADB1C2">.</span><span style="color:#565869">x </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 10</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // Triggers the listener</span></span>
<span class="line"><span style="color:#565869">state</span><span style="color:#ADB1C2">.</span><span style="color:#565869">x </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 10</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // No trigger (same value)</span></span>
<span class="line"><span style="color:#565869">state</span><span style="color:#ADB1C2">.</span><span style="color:#565869">x </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 20</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // Triggers the listener again</span></span></code></pre>
<p>But then we could get super original and wrap this in a helper function.  And since we’re hip let’s call it a <code>hook</code> instead of a wrapper function… let’s call it the <code>useState</code> hook</p>
<pre class="astro-code snazzy-light" style="background-color:#FAFBFC;color:#565869;overflow-x:auto" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F767BB">let</span><span style="color:#565869"> stateId </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 0</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#09A1ED"> useState</span><span style="color:#ADB1C2"> =</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">initialValue</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> =&gt;</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#F767BB">    const</span><span style="color:#565869"> id </span><span style="color:#ADB1C2">=</span><span style="color:#565869"> stateId</span><span style="color:#ADB1C2">++;</span></span>
<span class="line"><span style="color:#F767BB">    const</span><span style="color:#565869"> property </span><span style="color:#ADB1C2">=</span><span style="color:#ADB1C2"> `</span><span style="color:#CF9C00">state_</span><span style="color:#ADB1C2">${</span><span style="color:#565869">id</span><span style="color:#ADB1C2">}`</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#ADB1C2">    // Initialize the state if it doesn&#39;t exist</span></span>
<span class="line"><span style="color:#ADB1C2">    // Remember: this is our Proxy</span></span>
<span class="line"><span style="color:#F767BB">    if</span><span style="color:#ADB1C2"> (!(</span><span style="color:#565869">property </span><span style="color:#ADB1C2">in</span><span style="color:#565869"> state</span><span style="color:#ADB1C2">))</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#565869">        state</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">]</span><span style="color:#ADB1C2"> =</span><span style="color:#565869"> initialValue</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#ADB1C2">    }</span></span>
<span class="line"><span style="color:#ADB1C2">    // Create a reactive variable</span></span>
<span class="line"><span style="color:#F767BB">    const</span><span style="color:#565869"> reactiveVar </span><span style="color:#ADB1C2">=</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#11658F">        _property</span><span style="color:#ADB1C2">:</span><span style="color:#565869"> property</span><span style="color:#ADB1C2">,</span></span>
<span class="line"><span style="color:#F767BB">        get</span><span style="color:#09A1ED"> value</span><span style="color:#ADB1C2">()</span><span style="color:#ADB1C2"> {</span><span style="color:#F767BB"> return</span><span style="color:#565869"> state</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">];</span><span style="color:#ADB1C2"> },</span></span>
<span class="line"><span style="color:#F767BB">        set</span><span style="color:#09A1ED"> value</span><span style="color:#ADB1C2">(</span><span style="color:#565869">newValue</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> {</span><span style="color:#565869"> state</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">]</span><span style="color:#ADB1C2"> =</span><span style="color:#565869"> newValue</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> }</span></span>
<span class="line"><span style="color:#ADB1C2">    };</span></span>
<span class="line"><span style="color:#F767BB">    const</span><span style="color:#09A1ED"> setState</span><span style="color:#ADB1C2"> =</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">newValue</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> =&gt;</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#565869">        state</span><span style="color:#ADB1C2">[</span><span style="color:#565869">property</span><span style="color:#ADB1C2">]</span><span style="color:#ADB1C2"> =</span><span style="color:#565869"> newValue</span><span style="color:#ADB1C2">;</span></span>
<span class="line"><span style="color:#ADB1C2">    };</span></span>
<span class="line"><span style="color:#F767BB">    return</span><span style="color:#ADB1C2"> [</span><span style="color:#565869">reactiveVar</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> setState</span><span style="color:#ADB1C2">];</span></span>
<span class="line"><span style="color:#ADB1C2">};</span></span></code></pre>
<p><p>Now we can use our hook to create a counter.</p></p>
<pre class="astro-code snazzy-light" style="background-color:#FAFBFC;color:#565869;overflow-x:auto" tabindex="0" data-language="js"><code><span class="line"><span style="color:#ADB1C2">// Example usage</span></span>
<span class="line"><span style="color:#F767BB">const</span><span style="color:#ADB1C2"> [</span><span style="color:#565869">count</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> setCount</span><span style="color:#ADB1C2">]</span><span style="color:#ADB1C2"> =</span><span style="color:#09A1ED"> useState</span><span style="color:#ADB1C2">(</span><span style="color:#FF5C57">0</span><span style="color:#ADB1C2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADB1C2">// key is now on ._property.  not the greatest API but it works.</span></span>
<span class="line"><span style="color:#09A1ED">listen</span><span style="color:#ADB1C2">(</span><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">_property</span><span style="color:#ADB1C2">,</span><span style="color:#ADB1C2"> (</span><span style="color:#565869">value</span><span style="color:#ADB1C2">)</span><span style="color:#ADB1C2"> =&gt;</span><span style="color:#ADB1C2"> {</span></span>
<span class="line"><span style="color:#565869">    console</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">log</span><span style="color:#ADB1C2">(</span><span style="color:#ADB1C2">&quot;</span><span style="color:#CF9C00">Count changed to:</span><span style="color:#ADB1C2">&quot;</span><span style="color:#ADB1C2">,</span><span style="color:#565869"> value</span><span style="color:#ADB1C2">);</span></span>
<span class="line"><span style="color:#ADB1C2">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADB1C2">// value is now on .value.  not the greatest API but it works.</span></span>
<span class="line"><span style="color:#565869">console</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">log</span><span style="color:#ADB1C2">(</span><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#09A1ED">setCount</span><span style="color:#ADB1C2">(</span><span style="color:#FF5C57">20</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // Triggers the listener</span></span>
<span class="line"><span style="color:#09A1ED">setCount</span><span style="color:#ADB1C2">(</span><span style="color:#FF5C57">20</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // No trigger (same value)</span></span>
<span class="line"><span style="color:#09A1ED">setCount</span><span style="color:#ADB1C2">(</span><span style="color:#FF5C57">5</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // Triggers the listener again</span></span>
<span class="line"><span style="color:#565869">console</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">log</span><span style="color:#ADB1C2">(</span><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // 5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADB1C2">// We could also just use the property directly</span></span>
<span class="line"><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 10</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // Triggers the listener</span></span>
<span class="line"><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 10</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // No trigger (same value)</span></span>
<span class="line"><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value </span><span style="color:#ADB1C2">=</span><span style="color:#FF5C57"> 20</span><span style="color:#ADB1C2">;</span><span style="color:#ADB1C2"> // Triggers the listener again</span></span>
<span class="line"><span style="color:#565869">console</span><span style="color:#ADB1C2">.</span><span style="color:#09A1ED">log</span><span style="color:#ADB1C2">(</span><span style="color:#565869">count</span><span style="color:#ADB1C2">.</span><span style="color:#565869">value</span><span style="color:#ADB1C2">);</span><span style="color:#ADB1C2"> // 20</span></span></code></pre>
<script>

// our initial state
const initialState = {}
// a map of properties to their subscribers
const listeners = new Map();
// our proxy
const state = new Proxy(initialState, {
  set(target, property, value) {
      const old = target[property];
      target[property] = value;
      if(old !== value){
          if (listeners.has(property)) {
              // if we have subscribers for this property, run them
              listeners.get(property).forEach(fn => fn(value));
          }
      }
      return true;
  }
});

// now our listener creator
const listen = (property, fn) => {
listeners.set(property, [...(listeners.get(property) || []), fn]);
}

// we can now listen to changes on x
listen("x", (v) => {
  console.log("x changed to", v);
});

console.log('-----initial implementation-----');

state.x = 10; // Triggers the listener
state.x = 10; // No trigger (same value)
state.x = 20; // Triggers the listener again

let stateId = 0;
const useState = (initialValue) => {
  const id = stateId++;
  const property = 'state_0.7652764343958474';
  // Initialize the state if it doesn't exist
  // Remember: this is our Proxy
  if (!(property in state)) {
      state[property] = initialValue;
  }

  // Create a reactive variable
  const reactiveVar = {
      _property: property,
      get value() { return state[property]; },
      set value(newValue) { state[property] = newValue; }
  };

  const setState = (newValue) => {
      state[property] = newValue;
  };


  return [reactiveVar, setState];
};

// Example usage
const [count, setCount] = useState(0);

// key is now on ._property.  not the greatest API but it works.
listen(count._property, (value) => {
  console.log("Count changed to:", value);
});

console.log('-----useState implementation-----');

// value is now on .value.  not the greatest API but it works.
console.log(count.value); // 0
setCount(20); // Triggers the listener
setCount(20); // No trigger (same value)
setCount(5); // Triggers the listener again
console.log(count.value); // 5

// We could also just set the value directly
console.log('-----setting the value property directly-----');
count.value = 10; // Triggers the listener
count.value = 10; // No trigger (same value)
count.value = 20; // Triggers the listener again
console.log(count.value); // 20
</script>