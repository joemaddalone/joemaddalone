<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="57x57" href="/assets/apple-icon-57x57.034c3e17.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/apple-icon-60x60.d1b335d8.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/apple-icon-72x72.639c03b3.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/apple-icon-76x76.d1818067.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/apple-icon-114x114.07a3b4e8.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/apple-icon-120x120.ac9883bb.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/apple-icon-144x144.9f8d2b36.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/apple-icon-152x152.77f1b6fb.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.b2a7fc8d.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/android-icon-192x192.2a711125.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.71f7d1c5.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon-96x96.498e56db.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.5a17786a.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.11.1/tachyons.min.css" integrity="sha512-d0v474klOFSF7qD9WDvyRxAvXaWSxCHDZdnBSZQjo8BpVr6vpjwAgqetpqkKP38DzlOzdVPaLVnzzW1Ba8wB9w==" crossorigin="anonymous"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css"><link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet"><title>ollama | joe talks too much</title><meta name="description" content="ollama + langchain"><meta name="robots" content="index,follow"><meta name="author" content="Joe Maddalone"><link rel="canonical" href="https://joemaddalone.com/ollama/"><meta property="og:title" content="ollama | joe talks too much"><meta property="og:type" content="article"><meta property="og:url" content="https://joemaddalone.com/ollama/"><meta property="og:description" content="ollama + langchain"><meta property="og:image" content="https://joemaddalone.com/assets/android-icon-192x192.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@joemaddalone"><meta name="twitter:url" content="https://joemaddalone.com/ollama/"><meta name="twitter:title" content="ollama | joe talks too much"><meta name="twitter:description" content="ollama + langchain"><meta name="twitter:image" content="https://joemaddalone.com/assets/android-icon-192x192.png">  <link rel="stylesheet" href="/assets/index.44fb1042.css">
</head><body><header class="flex items-center justify-between bb"><b><a href="/writes/">I write stuff. sometimes.</a></b> <a href="/"><img src="/assets/favicon-32x32.71f7d1c5.png" width="32" height="32" alt=""></a></header><main class="standard-article"><hgroup><h1>ollama</h1><p>ollama + langchain</p></hgroup><h2>What is Ollama?</h2><p><a href="https://ollama.ai/">Ollama</a> is a tool for downloading and running large language models. It's like bittorrent for open source LLMs.</p><h2>What is LangChain?</h2><p>First, an LLM chain is the chaining of multiple LLM calls. We do this in order to deal with the constraint of limited context challenges when interacting with large volumes of information.</p><ul><li><strong>System prompt</strong>: &quot;You are an assistant for question-answering tasks. Use the following code sample to answer the question. if you don't know the answer, just say that you don't know. Keep your answers concise.&quot;</li><li><strong>Context</strong>: &quot;Here is the code I'd like to discuss: ...code...&quot;</li><li><strong>Question</strong>: &quot;How can I further optimize this code?&quot;</li></ul><p>LLM Chains abstract away the complexity of multiple calls. <a href="https://www.langchain.com/">LangChain</a> is an LLM Chain library we can use to produce our LLM Chain in order to provide context which, hopefully, results in less hallucinations. LangChain also allows us to pair our LLM chain with document retrieval methods. Pulling in PDFs or database records as context for our LLM chain is, put mildly, awesome.</p><h2>Install ollama</h2><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> https://ollama.ai/install.sh <span class="token operator">|</span> <span class="token function">sh</span></code></pre><h2>Pull a model (or two, or three)</h2><pre class="language-bash"><code class="language-bash">ollama pull llama2<br>ollama pull codellama<br>ollama pull mistral</code></pre><h2>Start ollama</h2><p>If you get a <em>port already in use</em> error, this is common on Linux immediately after installation. It's already running.</p><pre class="language-bash"><code class="language-bash">ollama serve</code></pre><p>ollama is now available at http://localhost:11434</p><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> http://localhost:11434<br>Ollama is running<br><br><span class="token function">curl</span> http://localhost:11434/api/tags<br><span class="token punctuation">{</span><span class="token string">"models"</span>:<span class="token punctuation">[</span><br>	<span class="token punctuation">{</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"codellama:latest"</span>,<span class="token punctuation">..</span>.<span class="token punctuation">}</span>,<br>	<span class="token punctuation">{</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"llama2:latest"</span>,<span class="token punctuation">..</span>.<span class="token punctuation">}</span>,<br>	<span class="token punctuation">{</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"mistral:latest"</span>,<span class="token punctuation">..</span>.<span class="token punctuation">}</span><br><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>I personally run this on a custom port with</p><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">OLLAMA_HOST</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0:9494 ollama serve</code></pre><h2>Setup project</h2><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> ai-local<br><span class="token builtin class-name">cd</span> ai-local<br><span class="token function">npm</span> init -y<br><span class="token function">npm</span> i langchain<br><br><span class="token comment"># add "type": "module" to package.json</span><br></code></pre><h2>Our first app, impossible question</h2><pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span><br><span class="token comment">// run: node index.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Ollama <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/llms/ollama"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> ollama <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ollama</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  baseUrl<span class="token operator">:</span> <span class="token string">"http://localhost:11434"</span><span class="token punctuation">,</span><br>  model<span class="token operator">:</span> <span class="token string">"mistral"</span> <span class="token comment">// using the mistral LLM.</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token string">"What color is the house at 6353 Juan Tabo Blvd?"</span><br><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ollama</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><br><br><span class="token comment">// alternatively we could capture the response as a stream.</span><br><span class="token comment">// const stream = await ollama.stream(question);</span><br><span class="token comment">// for await (const chunk of stream) {</span><br><span class="token comment">// 	process.stdout.write(chunk);</span><br><span class="token comment">// }</span></code></pre><p>This should result in something along the lines of:</p><div class="ui ignored info message"><p>The color of the house at 6353 Juan Tabo Blvd ... would depend on the specific property and its owners. There are no records to indicate the color of this particular house...</p></div>Obviously the the LLM does not know the color of the house. Had we asked some more general question we would definitely get an answer, but I have purposely asked it something it does not know.<p>So let's give it some context.</p><h2>chain and Document and Stuff</h2><p>We covered what a <code>chain</code> is previously. To <code>Stuff</code> a chain is exactly what it sounds like. Fill it with stuff. In this case stuff it with <code>Documents</code></p><pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span><br><span class="token comment">// run: node index.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Ollama <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/llms/ollama"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> loadQAStuffChain <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/chains"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Document <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> ollama <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ollama</span><span class="token punctuation">(</span><span class="token comment">/*... same as before */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token string">"What color is the house at 6353 Juan Tabo Blvd?"</span><br><span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token function">loadQAStuffChain</span><span class="token punctuation">(</span>ollama<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> input_documents <span class="token operator">=</span> <span class="token punctuation">[</span><br>	<span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pageContent<span class="token operator">:</span> <span class="token string">"The color of the house at 6353 Juan Tabo Blvd is blue"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">chain</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> input_documents<span class="token punctuation">,</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><h3>result:</h3><div class="ui ignored info message">The color of the house at 6353 Juan Tabo is blue.</div><p>Much better. And kind of exciting when you observe what actually happened. We taught the model about something new. We could have told it anything. This example was a bit &quot;call and response&quot;. Let's see if it can infer information from slightly less direct context.</p><pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span><br><span class="token comment">// run: node index.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Ollama <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/llms/ollama"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> loadQAStuffChain <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/chains"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Document <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> ollama <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ollama</span><span class="token punctuation">(</span><span class="token comment">/*... same as before */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token string">"What color is the house at 6353 Juan Tabo Blvd?"</span><br><span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token function">loadQAStuffChain</span><span class="token punctuation">(</span>ollama<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> docs <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pageContent<span class="token operator">:</span> <span class="token string">"Houses on Juan Tabo Blvd are either red or blue"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pageContent<span class="token operator">:</span> <span class="token string">"0 through 9999 are valid addresses on Juan Tabo Blvd"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pageContent<span class="token operator">:</span> <span class="token string">"Houses on Juan Tabo Blvd with odd numbered addresses are red"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">chain</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> input_documents<span class="token punctuation">,</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><h3>result:</h3><div class="ui ignored info message"><p>The house at 6353 on Juan Tabo Blvd has a red address because it is an odd number. According to the context given, houses on Juan Tabo Blvd with odd numbered addresses are red.</p></div><h2>External documents</h2><p>Here I have moved our context data into a single external text file. We'll use the TextLoader from LangChain to convert it into a Document.</p><pre class="language-md"><code class="language-md">// jauntabo.txt<br>Houses on Juan Tabo Blvd are either red or blue.<br>0 through 9999 are valid addresses on Juan Tabo Blvd.<br>Houses on Juan Tabo Blvd with odd numbered addresses are red.</code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Ollama <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/llms/ollama"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> loadQAStuffChain <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/chains"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Document <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> TextLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document_loaders/fs/text"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> ollama <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ollama</span><span class="token punctuation">(</span><span class="token comment">/*... same as before */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token string">"What color is the house at 6353 on Juan Tabo Blvd?"</span><br><span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token function">loadQAStuffChain</span><span class="token punctuation">(</span>ollama<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextLoader</span><span class="token punctuation">(</span><span class="token string">"./jauntabo.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> input_documents <span class="token operator">=</span> <span class="token keyword">await</span> loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">chain</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> input_documents<span class="token punctuation">,</span> question <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><h3>result</h3><div class="ui ignored info message"><p>To determine the color of the house at 6353 Juan Tabo Blvd, we need to look at the address and see if it is an odd number. Since 6353 is an odd number, according to the information given, the house should be red. Therefore, the house at 6353 on Juan Tabo Blvd is red.</p></div><h2>Multiple external Documents</h2><p>Lastly, let's have the code read a directory of external text documents.</p><pre class="language-md"><code class="language-md">--> /jauntabo/a.txt<br>Houses on Juan Tabo Blvd are either red or blue.<br><br>--> /jauntabo/b.txt<br>0 through 9999 are valid addresses on Juan Tabo Blvd.<br><br>--> /jauntabo/c.txt<br>Houses on Juan Tabo Blvd with odd numbered addresses are red.<br><br>--> /jauntabo/d.txt -- this is a new piece of context for the LLM!<br>Houses on Juan Tabo Blvd with prime numbered addresses are blue.</code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Ollama <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/llms/ollama"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> loadQAStuffChain <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/chains"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> Document <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> TextLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document_loaders/fs/text"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> DirectoryLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"langchain/document_loaders/fs/directory"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> ollama <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ollama</span><span class="token punctuation">(</span><span class="token comment">/*... same as before */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token string">"What color is the house at 1901 on Juan Tabo Blvd?"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token function">loadQAStuffChain</span><span class="token punctuation">(</span>ollama<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectoryLoader</span><span class="token punctuation">(</span><span class="token string">"jauntabo"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token string">".txt"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">TextLoader</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> input_documents <span class="token operator">=</span> <span class="token keyword">await</span> loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">chain</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> input_documents<span class="token punctuation">,</span> question <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3>result</h3><div class="ui ignored info message"><p>The house at 1901 on Juan Tabo Blvd is blue.</p></div></main><footer class="flex justify-between"><div>I'm Joe Maddalone</div><div><i>This is not a blog, these pages are changed all the time.</i></div></footer><style></style></body></html>