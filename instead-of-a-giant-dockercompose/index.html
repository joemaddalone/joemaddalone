<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/x-icon" href="/assets/favicon.ico"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.12.5"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="57x57" href="/assets/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link href="//unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><title></title><link rel="stylesheet" href="/_astro/_slug_.BCJeLTLa.css"></head> <body> <div class="sticky top-0 z-50 bg-white/80 shadow-md"> <nav class="flex items-center justify-between text-black h-12"> <a class="mt1 ml-1" href="/"> <img src="/assets/favicon-32x32.png" width="32" height="32" alt=""> </a> </nav> </div>  <div class="content-container section-spacing"> <div class="prose
	prose-invert
  prose-h1:font-bold prose-h1:text-xl
	prose-body:text-black prose-body:text-base
	prose-headings:text-black
	prose-p:text-black
	prose-code:text-black
	prose-code:bg-inherit
	prose-code:font-thin
	prose-code:text-xs
	prose-code:italic
	prose-code:before:content-none
	prose-code:after:content-none
	prose-ul:list-disc prose-ul:pl-4
	prose-strong:text-black
	prose-ruby:text-black
	prose-li:text-black">   <meta charset="utf-8"/><hgroup><h1>Instead of a giant docker-compose</h1><p>Manage a shit-ton of smaller docker-compose files</p></hgroup>
<h2 id="the-problem">The problem</h2>
<p>I have multiple servers running in my home all doing their own thing for various people in our household.  I’m not gonna lie, most of them run off a giant docker-compose file.  But on some “play” servers I experiment more and get to try different organization strategies.</p>
<h2 id="the-current-solution">The “current” solution</h2>
<p>This is gonna seem like a no-brainer, here goes:</p>
<p>One master yml, bunches of includes.</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.4dupk.css"/><script type="module" src="/_astro/ec.p1z7b.js"></script><figure class="frame has-title"><figcaption class="header"><span class="title">docker-compose.yml</span></figcaption><pre data-language="yaml"><code><div class="ec-line"><div class="code"><span style="--0:#11658F">include</span><span style="--0:#646670">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">actual/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">codeserver/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">glance/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">homepage/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">tududi/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#11658F">path</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#646670">&#39;</span><span style="--0:#816100">vogon/docker-compose.yml</span><span style="--0:#646670">&#39;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="include:  - path: 'actual/docker-compose.yml'  - path: 'codeserver/docker-compose.yml'  - path: 'glance/docker-compose.yml'  - path: 'homepage/docker-compose.yml'  - path: 'tududi/docker-compose.yml'  - path: 'vogon/docker-compose.yml'"><div></div></button></div></figure></div>
<p>And then my docker-apps directroy structure looks like this:</p>
<div class="expressive-code"><figure class="frame is-terminal has-title"><figcaption class="header"><span class="title">docker-apps directory structure</span></figcaption><pre data-language="bash"><code><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">actual</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">data</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">codeserver</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">config</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">glance</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">config</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">homepage</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">config</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">tududi</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">config</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">vogon</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">config</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">│  </span><span style="--0:#565869"> </span><span style="--0:#816100">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">.env</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">├──</span><span style="--0:#565869"> </span><span style="--0:#816100">docker-compose.yml</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">└──</span><span style="--0:#565869"> </span><span style="--0:#816100">recompose.sh</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="├── actual│   ├── data│   └── docker-compose.yml├── codeserver│   ├── config│   └── docker-compose.yml├── glance│   ├── config│   └── docker-compose.yml├── homepage│   ├── config│   └── docker-compose.yml├── tududi│   ├── config│   └── docker-compose.yml├── vogon│   ├── config│   └── docker-compose.yml├── .env├── docker-compose.yml└── recompose.sh"><div></div></button></div></figure></div>
<p>Example of a <strong>sub-service</strong> glance/docker-compose.yml file:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">glance/docker-compose.yml</span></figcaption><pre data-language="yaml"><code><div class="ec-line"><div class="code"><span style="--0:#11658F">services</span><span style="--0:#646670">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#11658F">glance</span><span style="--0:#646670">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#11658F">container_name</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#816100">glance</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#11658F">image</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#816100">glanceapp/glance</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#11658F">restart</span><span style="--0:#646670">:</span><span style="--0:#565869"> </span><span style="--0:#816100">unless-stopped</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#11658F">volumes</span><span style="--0:#646670">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#816100">${APPDATADIR}/glance/config:/app/config</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#11658F">ports</span><span style="--0:#646670">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#646670">-</span><span style="--0:#565869"> </span><span style="--0:#816100">9000:8080</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="services:  glance:    container_name: glance    image: glanceapp/glance    restart: unless-stopped    volumes:      - ${APPDATADIR}/glance/config:/app/config    ports:      - 9000:8080"><div></div></button></div></figure></div>
<p>I use each directory to house any volumes, config data, etc. for that service.  Until it graduates to <strong>family-critical</strong> I’m okay with wiping this out occasionally.</p>
<p>And they all share the same .env file:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">.env</span></figcaption><pre data-language="env"><code><div class="ec-line"><div class="code"><span style="--0:#565869">COMPOSE_HTTP_TIMEOUT=&#39;60&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">APPDATADIR=&#39;/home/joe/docker-apps&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">GID=&#39;******&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">HOSTNAME=&#39;******&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">PGID=&#39;******&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">PUID=&#39;******&#39;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#565869">TZ=&#39;******&#39;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="COMPOSE_HTTP_TIMEOUT='60'APPDATADIR='/home/joe/docker-apps'GID='******'HOSTNAME='******'PGID='******'PUID='******'TZ='******'"><div></div></button></div></figure></div>
<p>And when I want to add or remove a service, I just edit the master docker-compose.yml file and restart the services.</p>
<p>I also have a recompose.sh script that I can run to completely rebuild all the services.</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">recompose.sh</span></figcaption><pre data-language="bash"><code><div class="ec-line"><div class="code"><span style="--0:#646670">#!/bin/bash</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">docker</span><span style="--0:#565869"> </span><span style="--0:#816100">compose</span><span style="--0:#565869"> </span><span style="--0:#816100">stop</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">docker</span><span style="--0:#565869"> </span><span style="--0:#816100">compose</span><span style="--0:#565869"> </span><span style="--0:#816100">rm</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">docker</span><span style="--0:#565869"> </span><span style="--0:#816100">compose</span><span style="--0:#565869"> </span><span style="--0:#816100">pull</span></div></div><div class="ec-line"><div class="code"><span style="--0:#066C9F">docker</span><span style="--0:#565869"> </span><span style="--0:#816100">compose</span><span style="--0:#565869"> </span><span style="--0:#816100">up</span><span style="--0:#565869"> </span><span style="--0:#1E753B">-d</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#!/bin/bashdocker compose stopdocker compose rmdocker compose pulldocker compose up -d"><div></div></button></div></figure></div>
<p>And I can run it with:</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">recompose.sh</span></figcaption><pre data-language="bash"><code><div class="ec-line"><div class="code"><span style="--0:#066C9F">./recompose.sh</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="./recompose.sh"><div></div></button></div></figure></div>   </div> </div>  <footer class="content-container page-footer"> <div class="border-t-1 border-gray-200 flex justify-between pt-6 pb-6 text-xs"> <div>I'm Joe Maddalone</div> <div><i>This is not a blog, these pages are changed all the time.</i></div> </div> </footer> </body></html>