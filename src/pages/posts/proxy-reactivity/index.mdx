---
title: 'Proxy Reactivity'
date: 2025-08-05
tags: ['post']
excerpt: 'kinda neat'
---


<hgroup>
	<h1>Proxy Reactivity</h1>
	<p>kinda neat</p>
</hgroup>

> The Proxy object enables you to create a proxy for another object, which can intercept and redefine fundamental operations for that object. - [MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

<p>Here is a method for basic reactivity using a Proxy.</p>

```js
// our initial state
const initialState = {}
// a map of properties to their subscribers
const listeners = new Map();
// our proxy
const state = new Proxy(initialState, {
    set(target, property, value) {
        const old = target[property];
        target[property] = value;
        if(old !== value){
            if (listeners.has(property)) {
                // if we have subscribers for this property, run them
                listeners.get(property).forEach(fn => fn(value));
            }
        }
        return true;
    }
});

// now our listener creator
const listen = (property, fn) => {
  listeners.set(property, [...(listeners.get(property) || []), fn]);
}

// we can now listen to changes on x
listen("x", (v) => {
    console.log("x changed to", v);
});

state.x = 10; // Triggers the listener
state.x = 10; // No trigger (same value)
state.x = 20; // Triggers the listener again
```
But then we could get super original and wrap this in a helper function.  And since we're hip let's call it a `hook` instead of a wrapper function... let's call it the `useState` hook

```js
let stateId = 0;
const useState = (initialValue) => {
    const id = stateId++;
    const property = `state_${id}`;
    // Initialize the state if it doesn't exist
    // Remember: this is our Proxy
    if (!(property in state)) {
        state[property] = initialValue;
    }
    // Create a reactive variable
    return {
        _property: property,
        get value() { return state[property]; },
        set value(newValue) { state[property] = newValue; }
    };
};
```

<p>
	Now we can use our hook to create a counter.
</p>

```js
// Example usage
const count = useState(0);

// key is now on ._property.  not the greatest API but it works.
listen(count._property, (value) => {
    console.log("Count changed to:", value);
});

// value is now on .value.  not the greatest API but it works.
console.log(count.value); // 0

count.value = 10; // Triggers the listener
count.value = 10; // No trigger (same value)
count.value = 20; // Triggers the listener again
console.log(count.value); // 20
```

### Replace the ugly parts

We're building our own thing so let's make it a little more specific to our needs.

```js del={2} ins={3-8}
const listen = (property, fn) => {
    listeners.set(property, [...(listeners.get(property) || []), fn]);
    if (property?._property) {
        listeners.set(property._property,
            [...(listeners.get(property._property) || []),
        fn]);
    }
}
// an now we can just.
listen(count, (value) => {
    console.log("Count changed to:", value);
});
```

Then we could just turn this all into an easy to use class

```js
class Stater {
  constructor(initialState = {}) {
    this.stateId = 0;
    this.listeners = new Map();
    // our proxy
    this.state = new Proxy(initialState, {
      set: (target, property, value) => {
        const old = target[property];
        target[property] = value;
        if (old !== value) {
          if (this.listeners.has(property)) {
            // if we have subscribers for this property, run them
            this.listeners.get(property).forEach((fn) => fn(value));
          }
        }
        return true;
      },
    });
  }
  listen(stateObj, fn) {
    if (stateObj && stateObj._property) {
      this.listeners.set(stateObj._property, [
        ...(this.listeners.get(stateObj._property) || []),
        fn,
      ]);
    }
  }
  useState(initialValue) {
    const property = `state_${this.stateId++}`;
    const listenRef = this.listen.bind(this);
    const stateRef = this.state;
    if (!(property in stateRef)) {
      stateRef[property] = initialValue;
    }
    return {
      _property: property,
      get value() {
        return stateRef[property];
      },
      set value(newValue) {
        stateRef[property] = newValue;
      },
      // simpler access to listener creation
      listen(fn) {
        listenRef(this, fn);
      },
    };
  }
}

const s = new Stater();
const count = s.useState(0);

count.listen((value) => {
  console.log("Count changed to:", value);
});

count.value = 10; // Count changed to: 10
count.value = 15;// Count changed to: 15
```

<script>
{`

// our initial state
const initialState = {}
// a map of properties to their subscribers
const listeners = new Map();
// our proxy
const state = new Proxy(initialState, {
    set(target, property, value) {
        const old = target[property];
        target[property] = value;
        if(old !== value){
            if (listeners.has(property)) {
                // if we have subscribers for this property, run them
                listeners.get(property).forEach(fn => fn(value));
            }
        }
        return true;
    }
});

// now our listener creator
const oldListen = (property, fn) => {
  listeners.set(property, [...(listeners.get(property) || []), fn]);
}

// we can now listen to changes on x
oldListen("x", (v) => {
    console.log("x changed to", v);
});

console.log('-----initial implementation-----');

state.x = 10; // Triggers the listener
state.x = 10; // No trigger (same value)
state.x = 20; // Triggers the listener again

let stateId = 0;
const useState = (initialValue) => {
    const id = stateId++;
    const property = 'state_${Math.random()}';
    // Initialize the state if it doesn't exist
    // Remember: this is our Proxy
    if (!(property in state)) {
        state[property] = initialValue;
    }
    return {
        _property: property,
        get value() { return state[property]; },
        set value(newValue) { state[property] = newValue; }
    };
};

// Example usage
count = useState(0);

const listen = (property, fn) => {
    if (property?._property) {
        listeners.set(property._property,
            [...(listeners.get(property._property) || []),
        fn]);
    }
}

console.log('-----useState implementation-----');
count.value = 10; // Triggers the listener
count.value = 10; // No trigger (same value)
count.value = 20; // Triggers the listener again
console.log(count.value); // 20

`}
</script>


### Obligatory counter example:

```js
const s = new Stater();
const count = s.useState(0);

count.listen((value) => {
  document.querySelector('#count').textContent = value;
});

const add = document.querySelector('#plus');
add.addEventListener('click', () => {
	count.value++;
});

const minus = document.querySelector('#minus');
minus.addEventListener('click', () => {
	count.value--;
});
```

<div class="flex justify-center items-center gap-2 m-4">
  <button id="minus" class="pointer bg-blue-500 text-white p-2 rounded-md" type="button">-</button>
  <div class="text-2xl text-black" id="count">0</div>
  <button id="plus" class="pointer bg-blue-500 text-white p-2 rounded-md" type="button">+</button>
</div>


<script>
{`
class Stater {
  constructor(initialState = {}) {
    this.stateId = 0;
    this.listeners = new Map();
    // our proxy
    this.state = new Proxy(initialState, {
      set: (target, property, value) => {
        const old = target[property];
        target[property] = value;
        if (old !== value) {
          if (this.listeners.has(property)) {
            // if we have subscribers for this property, run them
            this.listeners.get(property).forEach((fn) => fn(value));
          }
        }
        return true;
      },
    });
  }
  listen(stateObj, fn) {
    if (stateObj && stateObj._property) {
      this.listeners.set(stateObj._property, [
        ...(this.listeners.get(stateObj._property) || []),
        fn,
      ]);
    }
  }
  useState(initialValue) {
    const property = 'state_' + this.stateId++;
    const listenRef = this.listen.bind(this);
    const stateRef = this.state;
    if (!(property in stateRef)) {
      stateRef[property] = initialValue;
    }
    return {
      _property: property,
      get value() {
        return stateRef[property];
      },
      set value(newValue) {
        stateRef[property] = newValue;
      },
      // simpler access to listener creation
      listen(fn) {
        listenRef(this, fn);
      },
    };
  }
}

const s = new Stater();
const count = s.useState(0);

count.listen((value) => {
  document.querySelector('#count').textContent = value;
});

const add = document.querySelector('#plus');
add.addEventListener('click', () => {
	count.value++;
});

const minus = document.querySelector('#minus');
minus.addEventListener('click', () => {
	count.value--;
});




`}
</script>

By no means is this a production-ready solution, but it's a fun way to learn about the Proxy object and how to use it to create a simple reactive system.

<hr />

### TKAdjustableNumber (just for fun)

<p class="select-none">When you eat <span id="cookies" class=" text-blue-500 font-bold underline decoration-dotted cursor-col-resize">3 cookies</span>,
you consume <span id="calories" class="font-bold">150</span> calories. That's <span id="percentage" class="font-bold">7</span>%
of your recommended daily calories.</p>

<script>
{`
const cookieCount = s.useState(0);

cookieCount.listen((value) => {
  document.querySelector('#cookies').textContent = value + ' cookies';
  document.querySelector('#calories').textContent = value * 50;
  document.querySelector('#percentage').textContent = (value * 50 / 2000 * 100).toFixed(2);
});

const cookie = document.querySelector('#cookies');

const mover = (e) => {
  // if move right, increment
  if (e.movementX > 0) {
    cookieCount.value++;
  }
  // if move left, decrement
  if (e.movementX < 0) {
    if (cookieCount.value > 2) {
      cookieCount.value = cookieCount.value-1;
    }
  }
};

cookie.addEventListener('mousedown', (e) => {
  document.addEventListener('mousemove', mover);
  document.addEventListener('mouseup', (e) => {
    document.removeEventListener('mousemove', mover);
  });
});

`}
</script>


